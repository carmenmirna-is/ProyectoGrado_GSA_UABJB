{% load static %}
<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enviar Solicitud - UABJB</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <style>
        /* Estilos para el contenedor del PDF din√°mico */
        #pdf-container {
            margin-top: 20px;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pdf-viewer-wrapper {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            background-color: #f9fafb;
            margin-bottom: 15px;
        }
        
        #pdf-viewer {
            border: none;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .condiciones-checkbox-wrapper {
            background-color: #fef3c7;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #f59e0b;
        }
        
        .condiciones-checkbox-wrapper label {
            color: #92400e;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
            cursor: pointer;
        }
        
        #mensaje-no-documento {
            margin-top: 20px;
            background-color: #e0f2fe;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #0284c7;
            color: #075985;
        }
        
        #mensaje-no-documento i {
            color: #0369a1;
            margin-right: 8px;
        }
    </style>
</head>
<body class="enviar-solicitud">
    <div class="header enviar-solicitud">
        <div class="header-content enviar-solicitud">
            <div style="display: flex; align-items: center; gap: 1.5rem;">
                <div class="logo enviar-solicitud"><i class="fas fa-graduation-cap"></i></div>
                <div>
                    <div class="header-title enviar-solicitud"><i class="fas fa-calendar-plus"></i> Enviar Solicitud</div>
                    <div class="header-subtitle enviar-solicitud">Sistema de Gesti√≥n UABJB</div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="container-box" style="max-width: 900px; margin: 2rem auto; padding: 2rem;">
            <div class="form-container">
                <h1><i class="fas fa-paper-plane"></i> Enviar Solicitud</h1>

                <form method="post" enctype="multipart/form-data" id="solicitudForm">
                    {% csrf_token %}
                    <input type="hidden" name="form_token" value="{{ form_token }}">

                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-danger{% endif %}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}

                    <!-- Campos del formulario -->
                    <div class="input-group" style="--animation-order: 0">
                        <label><i class="fas fa-calendar-alt"></i> Nombre del evento</label>
                        <input type="text" name="nombre_evento" required>
                    </div>

                    <div class="input-group" style="--animation-order: 1">
                        <label><i class="fas fa-align-left"></i> Descripci√≥n</label>
                        <textarea name="descripcion_evento" rows="4"></textarea>
                    </div>

                    <div class="input-group" style="--animation-order: 2">
                        <label><i class="fas fa-clock"></i> Fecha de inicio</label>
                        <input type="datetime-local" name="fecha_evento" required>
                    </div>

                    <div class="input-group" style="--animation-order: 3">
                        <label><i class="fas fa-clock"></i> Fecha de finalizaci√≥n (opcional)</label>
                        <input type="datetime-local" name="fecha_fin_evento">
                    </div>

                    <!-- Tipo de espacio -->
                    <div class="input-group" style="--animation-order: 4">
                        <label><i class="fas fa-list"></i> Tipo de espacio</label>
                        <select name="tipo_espacio" required id="tipo_espacio" onchange="toggleEspaciosYTerminos(this.value)">
                            <option value="">---</option>
                            <option value="carrera">Espacio de Carrera</option>
                            <option value="campus">Espacio de Campus</option>
                        </select>
                    </div>

                    <!-- Espacio de carrera -->
                    <div class="input-group" id="espacioCarreraDiv" style="display:none;">
                        <label><i class="fas fa-map-marker-alt"></i> Espacio de carrera</label>
                        <select name="espacio_carrera" id="espacio_carrera">
                            <option value="">---</option>
                            {% for e in espacios_carrera %}
                                <option value="{{ e.id }}">{{ e.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Espacio de campus -->
                    <div class="input-group" id="espacioCampusDiv" style="display:none;">
                        <label><i class="fas fa-university"></i> Espacio de campus</label>
                        <select name="espacio_campus" id="espacio_campus">
                            <option value="">---</option>
                            {% for e in espacios_campus %}
                                <option value="{{ e.id }}" data-nombre="{{ e.nombre }}">{{ e.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- ‚úÖ SECCI√ìN DIN√ÅMICA DE DOCUMENTO DE CONDICIONES -->
                <div id="pdf-container" style="display: none;">
                    <div class="input-group">
                        <label>
                            <i class="fas fa-file-pdf"></i> 
                            <span id="titulo-documento">Condiciones de Uso del Espacio</span>
                        </label>
                        
                        <!-- Bot√≥n para abrir PDF en nueva pesta√±a -->
                        <div style="margin-bottom: 15px; padding: 15px; background-color: #dbeafe; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <i class="fas fa-info-circle" style="color: #1e40af; font-size: 20px;"></i>
                                <span style="color: #1e3a8a; font-weight: 500;">
                                    Es obligatorio leer el documento de condiciones antes de continuar
                                </span>
                            </div>
                            <a id="btn-abrir-pdf" 
                            href="" 
                            target="_blank" 
                            class="btn-primary" 
                            style="display: inline-flex; align-items: center; gap: 8px; text-decoration: none; padding: 12px 20px;">
                                <i class="fas fa-external-link-alt"></i>
                                Abrir Documento en Nueva Pesta√±a
                            </a>
                        </div>
                        
                        <!-- Visor de PDF embebido (con fallback) -->
                        <div class="pdf-viewer-wrapper">
                            <div id="pdf-loading" style="text-align: center; padding: 40px; color: #666;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
                                <p>Cargando documento...</p>
                            </div>
                            
                            <!-- Opci√≥n 1: Iframe tradicional -->
                            <iframe id="pdf-viewer" 
                                    src="" 
                                    width="100%" 
                                    height="500px"
                                    style="display: none;">
                            </iframe>
                            
                            <!-- Opci√≥n 2: Embed como alternativa -->
                            <embed id="pdf-embed" 
                                src="" 
                                type="application/pdf" 
                                width="100%" 
                                height="500px"
                                style="display: none;">
                            
                            <!-- Mensaje si no se puede mostrar -->
                            <div id="pdf-error" style="display: none; text-align: center; padding: 40px; background-color: #fef3c7; border-radius: 8px;">
                                <i class="fas fa-exclamation-triangle" style="color: #f59e0b; font-size: 48px; margin-bottom: 15px;"></i>
                                <p style="color: #92400e; font-weight: 500; margin-bottom: 10px;">
                                    No se puede mostrar el PDF en esta ventana
                                </p>
                                <p style="color: #78350f; margin-bottom: 20px;">
                                    Por favor, abre el documento usando el bot√≥n de arriba
                                </p>
                            </div>
                        </div>
                        
                        <div class="condiciones-checkbox-wrapper">
                            <label for="acepta_condiciones_uso">
                                <input type="checkbox" 
                                    class="form-check-input" 
                                    id="acepta_condiciones_uso" 
                                    name="acepta_condiciones_uso"
                                    style="width: 20px; height: 20px; margin: 0;">
                                <span>
                                    <i class="fas fa-check-circle"></i> 
                                    <strong>He le√≠do y acepto</strong> las condiciones de uso de este espacio. 
                                    Me comprometo a cumplir con todas las normativas establecidas.
                                </span>
                            </label>
                        </div>
                    </div>
                </div>

                    <!-- ‚ö†Ô∏è MENSAJE CUANDO NO HAY DOCUMENTO -->
                    <div id="mensaje-no-documento" style="display: none;">
                        <i class="fas fa-info-circle"></i> 
                        <strong>Informaci√≥n:</strong> Este espacio no tiene condiciones especiales que aceptar.
                    </div>

                    <!-- Archivo Adjunto -->
                    <div class="input-group" style="--animation-order: 6">
                        <label><i class="fas fa-paperclip"></i> Archivo adjunto (obligatorio)</label>
                        <div class="file-upload-container">
                            <input type="file" name="archivo_adjunto" id="archivo_adjunto" required>
                            <div class="file-upload-area" onclick="document.getElementById('archivo_adjunto').click()">
                                <div class="upload-content">
                                    <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                                    <div class="upload-sub">Formatos: PDF, JPG, PNG, DOC, DOCX</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary" id="btn-enviar">
                        <i class="fas fa-paper-plane"></i> Enviar Solicitud
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- ‚úÖ SCRIPT PARA GESTI√ìN DIN√ÅMICA DE DOCUMENTOS -->
    <script>
        function toggleEspaciosYTerminos(tipo) {
            const carreraDiv = document.getElementById('espacioCarreraDiv');
            const campusDiv = document.getElementById('espacioCampusDiv');
            const pdfContainer = document.getElementById('pdf-container');
            const mensajeNoDocumento = document.getElementById('mensaje-no-documento');
            const espacioCampusSelect = document.getElementById('espacio_campus');

            if (tipo === 'carrera') {
                carreraDiv.style.display = 'block';
                campusDiv.style.display = 'none';
                pdfContainer.style.display = 'none';
                mensajeNoDocumento.style.display = 'none';
            } else if (tipo === 'campus') {
                carreraDiv.style.display = 'none';
                campusDiv.style.display = 'block';
                
                // Si ya hay un espacio seleccionado, cargar su documento
                if (espacioCampusSelect.value) {
                    cargarDocumentoEspacio(espacioCampusSelect.value);
                }
            } else {
                carreraDiv.style.display = 'none';
                campusDiv.style.display = 'none';
                pdfContainer.style.display = 'none';
                mensajeNoDocumento.style.display = 'none';
            }
        }

        // üîÑ Funci√≥n para cargar documento din√°micamente (MEJORADA)
        async function cargarDocumentoEspacio(espacioId) {
            const pdfContainer = document.getElementById('pdf-container');
            const pdfViewer = document.getElementById('pdf-viewer');
            const pdfEmbed = document.getElementById('pdf-embed');
            const pdfLoading = document.getElementById('pdf-loading');
            const pdfError = document.getElementById('pdf-error');
            const btnAbrirPdf = document.getElementById('btn-abrir-pdf');
            const checkboxCondiciones = document.getElementById('acepta_condiciones_uso');
            const mensajeNoDocumento = document.getElementById('mensaje-no-documento');
            const tituloDocumento = document.getElementById('titulo-documento');
            
            if (!espacioId) {
                pdfContainer.style.display = 'none';
                mensajeNoDocumento.style.display = 'none';
                checkboxCondiciones.checked = false;
                return;
            }
            
            try {
                const response = await fetch(`/usuarios/api/documento-espacio/${espacioId}/`);
                const data = await response.json();
                
                if (data.success && data.tiene_documento) {
                    // ‚úÖ Mostrar contenedor
                    pdfContainer.style.display = 'block';
                    mensajeNoDocumento.style.display = 'none';
                    
                    // Actualizar t√≠tulo
                    if (data.nombre_espacio) {
                        tituloDocumento.textContent = `Condiciones de Uso - ${data.nombre_espacio}`;
                    }
                    
                    // Configurar URL del bot√≥n
                    btnAbrirPdf.href = data.documento_url;
                    
                    // Resetear checkbox
                    checkboxCondiciones.checked = false;
                    checkboxCondiciones.required = true;
                    
                    // Mostrar loading
                    pdfLoading.style.display = 'block';
                    pdfViewer.style.display = 'none';
                    pdfEmbed.style.display = 'none';
                    pdfError.style.display = 'none';
                    
                    // Intentar cargar PDF en iframe
                    pdfViewer.src = data.documento_url;
                    
                    // Despu√©s de 2 segundos, verificar si carg√≥
                    setTimeout(() => {
                        pdfLoading.style.display = 'none';
                        
                        try {
                            // Intentar con iframe primero
                            pdfViewer.style.display = 'block';
                            
                            // Si no funciona el iframe, intentar con embed
                            pdfViewer.onerror = function() {
                                pdfViewer.style.display = 'none';
                                pdfEmbed.src = data.documento_url;
                                pdfEmbed.style.display = 'block';
                                
                                // Si tampoco funciona embed, mostrar error
                                pdfEmbed.onerror = function() {
                                    pdfEmbed.style.display = 'none';
                                    pdfError.style.display = 'block';
                                };
                            };
                        } catch (e) {
                            // Si hay error, mostrar mensaje
                            pdfViewer.style.display = 'none';
                            pdfEmbed.style.display = 'none';
                            pdfError.style.display = 'block';
                        }
                    }, 2000);
                    
                } else if (data.success && !data.tiene_documento) {
                    // ‚ö†Ô∏è No hay documento
                    pdfContainer.style.display = 'none';
                    mensajeNoDocumento.style.display = 'block';
                    mensajeNoDocumento.innerHTML = `
                        <i class="fas fa-info-circle"></i> 
                        <strong>Informaci√≥n:</strong> ${data.mensaje}
                    `;
                    checkboxCondiciones.checked = false;
                    checkboxCondiciones.required = false;
                } else {
                    pdfContainer.style.display = 'none';
                    mensajeNoDocumento.style.display = 'none';
                    checkboxCondiciones.required = false;
                }
                
            } catch (error) {
                console.error('Error al cargar documento:', error);
                pdfContainer.style.display = 'none';
                mensajeNoDocumento.style.display = 'block';
                mensajeNoDocumento.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>Error:</strong> No se pudo cargar el documento. Intenta nuevamente.
                `;
            }
        }

        // üì° Event listener para cambio de espacio de campus
        document.addEventListener('DOMContentLoaded', function() {
            const espacioCampusSelect = document.getElementById('espacio_campus');
            
            if (espacioCampusSelect) {
                espacioCampusSelect.addEventListener('change', function() {
                    cargarDocumentoEspacio(this.value);
                });
            }
        });
    </script>

    <!-- Scripts existentes -->
    <script src="{% static 'js/scripts.js' %}"></script>
    <script src="{% static 'js/verificacion-conflictos.js' %}"></script>
</body>
</html>