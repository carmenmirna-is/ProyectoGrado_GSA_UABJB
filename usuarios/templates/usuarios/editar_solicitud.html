{% load static %}
<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Solicitud - UABJB</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
</head>
<body class="enviar-solicitud">
    <div class="header">
        <div class="header-content">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="logo"><i class="fas fa-graduation-cap"></i></div>
                <div>
                    <div class="header-title"><i class="fas fa-edit"></i> Editar Solicitud</div>
                    <div class="header-subtitle">Sistema de Gesti贸n UABJB</div>
                </div>
            </div>
            <div class="header-controls">
                <div class="theme-toggle" onclick="toggleTheme()">
                    <i class="fas fa-moon" id="theme-icon"></i>
                    <span id="theme-text">Modo Oscuro</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <form method="POST" enctype="multipart/form-data" class="form-container">
            {% csrf_token %}
            <label><i class="fas fa-tag"></i> Nombre del Evento</label>
            <input type="text" name="nombre_evento" value="{{ solicitud.nombre_evento }}" required>

            <label><i class="fas fa-align-left"></i> Descripci贸n</label>
            <textarea name="descripcion_evento">{{ solicitud.descripcion_evento|default:'' }}</textarea>

            <label><i class="fas fa-calendar-alt"></i> Fecha y Hora del Evento</label>
            <input type="datetime-local" name="fecha_evento" value="{{ solicitud.fecha_evento|date:'Y-m-d\TH:i' }}" required>

            <label><i class="fas fa-calendar-check"></i> Fecha y Hora de Fin (opcional)</label>
            <input type="datetime-local" name="fecha_fin_evento" value="{{ solicitud.fecha_fin_evento|date:'Y-m-d\TH:i' }}">

            <label><i class="fas fa-map-marker-alt"></i> Tipo de Espacio</label>
            <select name="tipo_espacio" id="tipo_espacio" onchange="toggleEspacios()" required>
                <option value="carrera" {% if solicitud.tipo_espacio == 'carrera' %}selected{% endif %}>Espacio de Carrera</option>
                <option value="campus" {% if solicitud.tipo_espacio == 'campus' %}selected{% endif %}>Espacio de Campus</option>
            </select>

            <div id="espacio_carrera_group" style="display: {% if solicitud.tipo_espacio == 'carrera' %}block{% else %}none{% endif %};">
                <label><i class="fas fa-building"></i> Espacio de Carrera</label>
                <select name="espacio_carrera">
                    {% for e in espacios_carrera %}
                        <option value="{{ e.id }}" {% if solicitud.espacio_id == e.id %}selected{% endif %}>{{ e.nombre }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="espacio_campus_group" style="display: {% if solicitud.tipo_espacio == 'campus' %}block{% else %}none{% endif %};">
                <label><i class="fas fa-university"></i> Espacio de Campus</label>
                <select name="espacio_campus">
                    {% for e in espacios_campus %}
                        <option value="{{ e.id }}" {% if solicitud.espacio_campus_id == e.id %}selected{% endif %}>{{ e.nombre }}</option>
                    {% endfor %}
                </select>
            </div>

            <label><i class="fas fa-paperclip"></i> Archivo Adjunto (opcional)</label>
            <input type="file" name="archivo_adjunto">
            {% if solicitud.archivo_adjunto %}
                <p>Archivo actual: <a href="{{ solicitud.archivo_adjunto.url }}" target="_blank">{{ solicitud.archivo_adjunto.name }}</a></p>
            {% endif %}

            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Guardar Cambios
            </button>
            <a href="{% url 'usuarios:historial_solicitudes' %}" class="btn btn-cancel">
                <i class="fas fa-arrow-left"></i> Cancelar
            </a>
        </form>
    </div>

    <script>
        function toggleEspacios() {
            const tipo = document.getElementById('tipo_espacio').value;
            document.getElementById('espacio_carrera_group').style.display = tipo === 'carrera' ? 'block' : 'none';
            document.getElementById('espacio_campus_group').style.display = tipo === 'campus' ? 'block' : 'none';
        }
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const formulario = document.querySelector('form');
        const fechaEventoInput = document.querySelector('input[name="fecha_evento"]');
        const fechaFinInput = document.querySelector('input[name="fecha_fin_evento"]');
        const tipoEspacioSelect = document.querySelector('select[name="tipo_espacio"]');
        const espacioCarreraSelect = document.querySelector('select[name="espacio_carrera"]');
        const espacioCampusSelect = document.querySelector('select[name="espacio_campus"]');
        const submitButton = formulario.querySelector('button[type="submit"]');
        
        // Contenedor para mostrar advertencias
        let warningContainer = document.getElementById('conflictos-warning');
        if (!warningContainer) {
            warningContainer = document.createElement('div');
            warningContainer.id = 'conflictos-warning';
            warningContainer.style.display = 'none';
            warningContainer.style.marginTop = '15px';
            warningContainer.className = 'alert alert-warning';
            formulario.insertBefore(warningContainer, submitButton);
        }
        
        // Funci贸n para verificar conflictos
        async function verificarConflictos() {
            const fechaEvento = fechaEventoInput.value;
            const fechaFin = fechaFinInput ? fechaFinInput.value : '';
            const tipoEspacio = tipoEspacioSelect.value;
            const espacioId = tipoEspacio === 'carrera' ? 
                espacioCarreraSelect.value : 
                espacioCampusSelect.value;
            
            // Validar que tengamos los datos necesarios
            if (!fechaEvento || !tipoEspacio || !espacioId) {
                warningContainer.style.display = 'none';
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('fecha_evento', fechaEvento);
                if (fechaFin) formData.append('fecha_fin_evento', fechaFin);
                formData.append('tipo_espacio', tipoEspacio);
                if (tipoEspacio === 'carrera') {
                    formData.append('espacio_carrera', espacioId);
                } else {
                    formData.append('espacio_campus', espacioId);
                }
                
                const response = await fetch('/usuarios/verificar-conflictos/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });
                
                const data = await response.json();
                
                if (data.tiene_conflictos) {
                    mostrarAdvertenciaConflictos(data.conflictos);
                } else {
                    warningContainer.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error verificando conflictos:', error);
            }
        }
        
        // Funci贸n para mostrar advertencias
        function mostrarAdvertenciaConflictos(conflictos) {
            let html = `
                <div style="background-color: #fef3c7; border-left: 4px solid #fbbf24; padding: 15px; border-radius: 8px;">
                    <h4 style="color: #92400e; margin: 0 0 10px 0;">
                        锔 Advertencia: Conflictos de Horario
                    </h4>
                    <p style="margin: 0 0 10px 0; color: #78350f;">
                        Ya hay ${conflictos.length} reserva(s) aceptada(s) en este horario:
                    </p>
                    <ul style="margin: 0; padding-left: 20px; color: #78350f;">
            `;
            
            conflictos.forEach(conflicto => {
                html += `
                    <li style="margin-bottom: 8px;">
                        <strong>${conflicto.nombre_evento}</strong><br>
                        <small>
                             ${conflicto.fecha_inicio} - ${conflicto.fecha_fin}<br>
                             ${conflicto.solicitante}
                            ${conflicto.es_propio ? ' <span style="color: #1e3a8a;">(Tu reserva)</span>' : ''}
                        </small>
                    </li>
                `;
            });
            
            html += `
                    </ul>
                    <p style="margin: 10px 0 0 0; color: #78350f; font-size: 14px;">
                        <strong>Nota:</strong> Puedes enviar la solicitud de todas formas. 
                        El encargado decidir谩 si acepta o rechaza considerando estos conflictos.
                    </p>
                </div>
            `;
            
            warningContainer.innerHTML = html;
            warningContainer.style.display = 'block';
            
            // Scroll suave a la advertencia
            warningContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // Funci贸n para obtener CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Event listeners con debounce para evitar muchas llamadas
        let timeoutId;
        const debouncedCheck = () => {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(verificarConflictos, 500);
        };
        
        if (fechaEventoInput) {
            fechaEventoInput.addEventListener('change', debouncedCheck);
        }
        
        if (fechaFinInput) {
            fechaFinInput.addEventListener('change', debouncedCheck);
        }
        
        if (tipoEspacioSelect) {
            tipoEspacioSelect.addEventListener('change', debouncedCheck);
        }
        
        if (espacioCarreraSelect) {
            espacioCarreraSelect.addEventListener('change', debouncedCheck);
        }
        
        if (espacioCampusSelect) {
            espacioCampusSelect.addEventListener('change', debouncedCheck);
        }
    });
    </script>
    <script src="{% static 'js/scripts.js' %}"></script>
</body>
</html>